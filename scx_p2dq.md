# Linux å†…æ ¸ CFS è°ƒåº¦å™¨ï¼šè´Ÿè½½è¿½è¸ªä¸é€‰æ ¸æœºåˆ¶è¯¦è§£

## 1. æ ¸å¿ƒæ¦‚å¿µï¼šä»€ä¹ˆæ˜¯â€œè´Ÿè½½â€ (Load)ï¼Ÿ

åœ¨ CFS ä¸­ï¼Œâ€œè´Ÿè½½â€å¹¶ä¸æ˜¯ä¸€ä¸ªå•ä¸€çš„æ•°å€¼ï¼Œè€Œæ˜¯åˆ†ä¸ºä¸¤ä¸ªç»´åº¦çš„æŒ‡æ ‡ï¼Œå®ƒä»¬åœ¨ä¸åŒçš„åœºæ™¯ä¸‹èµ·ä½œç”¨ï¼š

### A. æƒé‡è´Ÿè½½ (Load / Weight)

- **å®šä¹‰**ï¼šåŸºäºä»»åŠ¡ä¼˜å…ˆçº§çš„è´Ÿè½½ã€‚
- **æ¥æº**ï¼šä¸ `nice` å€¼ï¼ˆåŠ cgroup æƒé‡ï¼‰ç›´æ¥ç›¸å…³ã€‚
  - `nice 0` çš„æƒé‡æ˜¯ 1024ã€‚
  - `nice -20` (é«˜ä¼˜å…ˆçº§) æƒé‡æå¤§ã€‚
- **ç”¨é€”**ï¼šä¸»è¦ç”¨äº**è´Ÿè½½å‡è¡¡ (Load Balance)**ã€‚å†…æ ¸å¸Œæœ›æ‰€æœ‰ CPU ä¸Šçš„â€œæ€»æƒé‡â€å¤§è‡´ç›¸ç­‰ã€‚å¦‚æœ CPU A ä¸Šæœ‰ä¸€ä¸ª nice -20 çš„ä»»åŠ¡ï¼ŒCPU B ä¸Šæœ‰ 10 ä¸ª nice 19 çš„ä»»åŠ¡ï¼ŒCFS ä¼šè®¤ä¸ºè¿™ä¸¤ä¸ª CPU è´Ÿè½½å¯èƒ½æ˜¯å¹³è¡¡çš„ï¼Œå› ä¸ºé«˜ä¼˜å…ˆçº§ä»»åŠ¡ç†åº”è·å¾—æ›´å¤š CPU æ—¶é—´ã€‚

### B. åˆ©ç”¨ç‡ (Utilization / Capacity)

- **å®šä¹‰**ï¼šåŸºäºç‰©ç†æ—¶é—´çš„è´Ÿè½½ã€‚
- **æ¥æº**ï¼šä»»åŠ¡å®é™…åœ¨ CPU ä¸Šè¿è¡Œäº†å¤šé•¿æ—¶é—´ï¼ˆ0% ~ 100%ï¼‰ã€‚
- **ç”¨é€”**ï¼šä¸»è¦ç”¨äº**é€‰æ ¸ (Task Placement)** å’Œ **è°ƒé¢‘ (Schedutil)**ã€‚ä¾‹å¦‚ï¼Œä¸€ä¸ªä»»åŠ¡å³ä½¿ä¼˜å…ˆçº§å¾ˆé«˜ï¼Œä½†å¦‚æœå®ƒ 90% çš„æ—¶é—´éƒ½åœ¨ç¡çœ ï¼ˆç­‰å¾… I/Oï¼‰ï¼Œå®ƒçš„åˆ©ç”¨ç‡å°±å¾ˆä½ã€‚å†…æ ¸ä¼šæŠŠå®ƒæ”¾åœ¨è¾ƒç©ºé—²æˆ–èƒ½æ•ˆæ›´å¥½çš„æ ¸ä¸Šã€‚

------

## 2. æ ¸å¿ƒç®—æ³•ï¼šPELT (Per-Entity Load Tracking)

ä¸ºäº†å‡†ç¡®ç»Ÿè®¡ä¸Šè¿°æŒ‡æ ‡ï¼ŒLinux ä½¿ç”¨äº† **PELTï¼ˆå®ä½“è´Ÿè½½è·Ÿè¸ªï¼‰** ç®—æ³•ã€‚

### ä¸ºä»€ä¹ˆéœ€è¦ PELTï¼Ÿ

åœ¨ PELT ä¹‹å‰ï¼Œå†…æ ¸é€šå¸¸åªç»Ÿè®¡æ•´ä¸ªè¿è¡Œé˜Ÿåˆ—ï¼ˆRunqueueï¼‰çš„è´Ÿè½½ã€‚è¿™å¯¼è‡´äº†ä¸€ä¸ªé—®é¢˜ï¼šå½“ä¸€ä¸ªç¹é‡çš„ä»»åŠ¡è¿ç§»åˆ°æ–° CPU æ—¶ï¼Œæ–° CPU çš„è´Ÿè½½ä¼šç¬é—´æš´æ¶¨ï¼Œæ—§ CPU ç¬é—´æš´è·Œï¼Œå¯¼è‡´è°ƒåº¦æ³¢åŠ¨ã€‚

PELT å®ç°äº†**å®ä½“çº§**çš„è·Ÿè¸ªï¼š**è´Ÿè½½æ˜¯è·Ÿç€ä»»åŠ¡ï¼ˆEntityï¼‰èµ°çš„**ã€‚ä»»åŠ¡å»å“ªï¼Œè´Ÿè½½å°±å¸¦åˆ°å“ªã€‚

### ç®—æ³•åŸç†

PELT å°†æ—¶é—´åˆ‡åˆ†æˆ 1024usï¼ˆçº¦ 1msï¼‰çš„çª—å£ã€‚å®ƒä½¿ç”¨**æŒ‡æ•°è¡°å‡ç§»åŠ¨å¹³å‡ (Geometric Series / Exponential Decay)** ç®—æ³•ã€‚

- **è¡°å‡å› å­**ï¼š$y = 1/32^{\frac{1}{32}}$ã€‚ç®€å•ç†è§£ï¼š**è´Ÿè½½æ¯ç»è¿‡ 32msï¼Œå½±å“åŠ›å°±ä¼šå‡åŠï¼ˆåŠè¡°æœŸï¼‰**ã€‚

- **å…¬å¼é€»è¾‘**ï¼š

  $$L_t = L_{t-1} \cdot y + P_t$$

  - $L_t$ï¼šå½“å‰æ—¶åˆ»çš„è´Ÿè½½ã€‚
  - $L_{t-1}$ï¼šä¸Šä¸€æ—¶åˆ»çš„è´Ÿè½½ï¼ˆè¡°å‡åï¼‰ã€‚
  - $P_t$ï¼šå½“å‰çª—å£å†…çš„è´¡çŒ®ï¼ˆå¦‚æœä»»åŠ¡åœ¨è¿è¡Œï¼Œå°±æ˜¯ 1ï¼›å¦‚æœåœ¨ç¡è§‰ï¼Œå°±æ˜¯ 0ï¼‰ã€‚

- ![Exponential decay graphçš„å›¾ç‰‡](https://encrypted-tbn2.gstatic.com/licensed-image?q=tbn:ANd9GcR0fcjnCgInfttxzDXMC2U_BSdQcqer4laNvY0_STdcizxzeD8AW1glF99PKRdYa20yOyC-J6Gbh5la7HS-Z7-Rs8zIAt3EFbwTJ6um1yIf92IHzUg)

- Shutterstock

*(æ­¤å¤„æ¦‚å¿µå›¾æè¿°ï¼šä¸€ä¸ªæ›²çº¿å›¾ã€‚å½“ä»»åŠ¡å¼€å§‹è¿è¡Œæ—¶ï¼Œåˆ©ç”¨ç‡æ›²çº¿ä¸æ˜¯ç¬é—´è·³åˆ° 100%ï¼Œè€Œæ˜¯åƒç”µå®¹å……ç”µä¸€æ ·å¹³æ»‘ä¸Šå‡ï¼›å½“ä»»åŠ¡åœæ­¢è¿è¡Œæ—¶ï¼Œæ›²çº¿å¹³æ»‘ä¸‹é™ï¼Œè€Œä¸æ˜¯ç¬é—´å½’é›¶ã€‚)*

### æµç¨‹å›¾ï¼šPELT æ›´æ–°æœºåˆ¶



```mermaid
graph LR
    A[æ—¶é’Ÿä¸­æ–­ / ä»»åŠ¡çŠ¶æ€å˜æ›´] --> B{ä»»åŠ¡åœ¨è¿è¡Œ?}
    B -- æ˜¯ --> C[ç´¯åŠ å½“å‰çª—å£è´Ÿè½½]
    B -- å¦ --> D[åªè¿›è¡ŒæŒ‡æ•°è¡°å‡]
    C --> E["æ›´æ–° load_avg (æƒé‡)"]
    C --> F["æ›´æ–° util_avg (åˆ©ç”¨ç‡)"]
    D --> E
    D --> F
    E --> G["èšåˆåˆ° cfs_rq (CPUæ€»è´Ÿè½½)"]
    F --> G
```

------

## 3. CFS å¦‚ä½•ç»Ÿè®¡ CPU è´Ÿè½½ï¼Ÿ

CFS çš„ç»Ÿè®¡æ˜¯è‡ªä¸‹è€Œä¸Šçš„å±‚çº§æ±‡æ€»ã€‚

1. **è°ƒåº¦å®ä½“ (`se`, Scheduling Entity)**ï¼šæ¯ä¸ªä»»åŠ¡ï¼ˆæˆ–ä»»åŠ¡ç»„ï¼‰éƒ½æœ‰è‡ªå·±çš„ `se.avg` ç»“æ„ä½“ï¼Œé‡Œé¢ç»´æŠ¤äº† `load_avg` å’Œ `util_avg`ã€‚
2. **è¿è¡Œé˜Ÿåˆ— (`cfs_rq`, Runqueue)**ï¼šæ¯ä¸ª CPU éƒ½æœ‰ä¸€ä¸ª `cfs_rq`ã€‚
   - **CPU çš„è´Ÿè½½ = è¯¥ CPU ä¸Šæ‰€æœ‰ `se` çš„è´Ÿè½½ä¹‹å’Œ**ã€‚
3. **æ›´æ–°æ—¶æœº**ï¼š
   - **enqueue/dequeue**ï¼šä»»åŠ¡è¿›å…¥æˆ–ç¦»å¼€é˜Ÿåˆ—æ—¶ã€‚
   - **tick**ï¼šæ¯æ¬¡æ—¶é’Ÿä¸­æ–­æ—¶ã€‚
   - **update_curr**ï¼šä»»åŠ¡åœ¨è¿è¡Œæ—¶ç´¯ç§¯æ—¶é—´ã€‚

**å…³é”®ç‚¹**ï¼šå³ä½¿ä»»åŠ¡åœ¨ç¡è§‰ï¼ˆBlockedï¼‰ï¼ŒPELT ä¹Ÿä¼šè®¡ç®—å…¶â€œé˜»å¡è´Ÿè½½â€ã€‚å½“å®ƒé†’æ¥æ—¶ï¼Œå†…æ ¸çŸ¥é“å®ƒä¹‹å‰æ˜¯ä¸ªâ€œå¿™ç¢Œâ€çš„ä»»åŠ¡ï¼Œè€Œä¸æ˜¯æŠŠå®ƒå½“æˆæ–°ä»»åŠ¡ä» 0 å¼€å§‹ç®—ã€‚

------

## 4. é€‰æ ¸æ—¶å¦‚ä½•è·å–è´Ÿè½½ä¿¡æ¯ï¼Ÿ

åœ¨ CFS ä¸­ï¼Œâ€œé€‰æ ¸â€ä¸»è¦å‘ç”Ÿåœ¨ä¸¤ä¸ªæ—¶åˆ»ï¼š**Forkï¼ˆåˆ›å»ºæ–°è¿›ç¨‹ï¼‰** å’Œ **Wakeupï¼ˆå”¤é†’è¿›ç¨‹ï¼‰**ã€‚æœ€å¸¸ç”¨çš„æ˜¯ Wakeup è·¯å¾„ï¼ˆ`select_task_rq_fair`ï¼‰ã€‚

### æµç¨‹ï¼šå”¤é†’é€‰æ ¸é€»è¾‘ (Wakeup Path)

ä»£ç æ®µ

```mermaid
graph TD
    A["ä»»åŠ¡è¢«å”¤é†’ (Wakeup)"] --> B("è¿›å…¥ select_task_rq_fair")
    B --> C{"æ˜¯å¦å¼€å¯ EAS (èƒ½æ•ˆè°ƒåº¦)?"}
    
    C -- "æ˜¯ (å¦‚æ‰‹æœº/å¼‚æ„CPU)" --> D["åˆ©ç”¨ util_avg å¯»æ‰¾èƒ½æ•ˆæœ€ä¼˜ CPU"]
    D --> E["é¢„æµ‹ä»»åŠ¡æ”¾åœ¨å“ªé‡Œæœ€çœç”µä¸”ä¸æ‹¥æŒ¤"]
    
    C -- "å¦ (å¦‚æœåŠ¡å™¨)" --> F{"å½“å‰ CPU æ˜¯å¦ç©ºé—²?"}
    F -- "æ˜¯ (å¿«é€Ÿè·¯å¾„)" --> G["æ£€æŸ¥æ˜¯å¦éœ€è¦å”¤é†’äº²å’Œæ€§ CPU"]
    F -- "å¦ (æ…¢é€Ÿè·¯å¾„)" --> H["éå†è°ƒåº¦åŸŸ (Sched Domain)"]
    
    H --> I["æŸ¥æ‰¾æœ€ç©ºé—²çš„ç»„ (Idlest Group)"]
    I --> J["åœ¨ç»„å†…æŸ¥æ‰¾æœ€ç©ºé—²çš„ CPU (Idlest CPU)"]
    
    J --> K["æ¯”è¾ƒ load_avg å’Œ util_avg"]
    K --> L["è¿”å›ç›®æ ‡ CPU"]
```

### å…³é”®æ­¥éª¤è§£æï¼š

1. **EAS (Energy Aware Scheduling) ä¼˜å…ˆ**ï¼š

   å¦‚æœç³»ç»Ÿæ”¯æŒ EASï¼ˆå¸¸è§äºç§»åŠ¨ç«¯ï¼‰ï¼Œå†…æ ¸ä¼šç›´æ¥è¯»å–ä»»åŠ¡çš„ `util_avg`ã€‚

   - å¦‚æœ `util_avg` å¾ˆå°ï¼Œæ”¾åœ¨å°æ ¸ï¼ˆLittle Coreï¼‰ã€‚
   - å¦‚æœ `util_avg` å¾ˆå¤§ï¼Œæ”¾åœ¨å¤§æ ¸ï¼ˆBig Coreï¼‰ã€‚
   - **ä¾æ®**ï¼šçº¯ç²¹çœ‹åˆ©ç”¨ç‡ï¼Œä¸çœ‹æƒé‡ã€‚

2. **ç©ºé—²æœç´¢ (Idle Search)**ï¼š

   å¦‚æœæ²¡æœ‰ EASï¼ŒCFS ä¼šä¼˜å…ˆå¯»æ‰¾ **Idle CPU**ã€‚

   - å†…æ ¸ä¼šå¿«é€Ÿæ‰«æ LLC åŸŸå†…çš„ CPUï¼Œçœ‹è°çš„åˆ©ç”¨ç‡æä½ã€‚

3. **è´Ÿè½½å‡è¡¡ (Load Balancing)**ï¼š

   å¦‚æœ CPU éƒ½å¾ˆå¿™ï¼Œåˆ™æ¯”è¾ƒ `load_avg`ï¼ˆæƒé‡è´Ÿè½½ï¼‰ã€‚

   - ç›®æ ‡ï¼šå°†ä»»åŠ¡æ”¾åˆ° `load_avg` æœ€ä½çš„ CPU ä¸Šï¼Œæˆ–è€…æ”¾åˆ°ä¸å…¶ä¸Šæ¬¡è¿è¡Œçš„ CPU å…±äº«ç¼“å­˜çš„ CPU ä¸Šï¼ˆCache Affinityï¼‰ã€‚

------

## 5. æ€»ç»“

| **æŒ‡æ ‡**     | **å˜é‡å (å†…æ ¸)**  | **å«ä¹‰**                        | **ä¸»è¦ç”¨é€”**                        | **ç®—æ³•åŸºç¡€** |
| ------------ | ------------------ | ------------------------------- | ----------------------------------- | ------------ |
| **æƒé‡è´Ÿè½½** | `se->avg.load_avg` | ä»»åŠ¡çš„ç¹å¿™ç¨‹åº¦ Ã— ä»»åŠ¡ä¼˜å…ˆçº§     | å†³å®šè°è¯¥è¢«è¿ç§» (è´Ÿè½½å‡è¡¡)           | PELT         |
| **åˆ©ç”¨ç‡**   | `se->avg.util_avg` | ä»»åŠ¡å ç”¨ CPU çš„ç‰©ç†æ—¶é—´æ¯”ä¾‹     | å†³å®šæ”¾åœ¨å¤§æ ¸è¿˜æ˜¯å°æ ¸ï¼Œä»¥åŠ CPU é¢‘ç‡ | PELT         |
| **CPU å®¹é‡** | `capacity`         | CPU çš„ç®—åŠ›ä¸Šé™ (å—çƒ­ã€é¢‘ç‡å½±å“) | åˆ¤æ–­ CPU æ˜¯å¦èƒ½å®¹çº³å½“å‰ä»»åŠ¡         | ç¡¬ä»¶åé¦ˆ     |

**ç®€å•ä¸€å¥è¯**ï¼šPELT åƒä¸€ä¸ªæå…¶çµæ•çš„è®°å½•å‘˜ï¼Œç»™æ¯ä¸ªä»»åŠ¡ç”»äº†ä¸€å¼ â€œå†å²ç”»åƒâ€ï¼ˆæ˜¯å¿™æ˜¯é—²ï¼Œæ˜¯å¾ˆé‡è¦è¿˜æ˜¯ä¸é‡è¦ï¼‰ã€‚CFS åœ¨é€‰æ ¸æ—¶ï¼Œå°±æ˜¯æ‹¿ç€è¿™å¼ ç”»åƒï¼Œå»å¯»æ‰¾æœ€é€‚åˆè¿™ä¸ªä»»åŠ¡çš„â€œå·¥ä½â€ï¼ˆCPUï¼‰ã€‚





p2dqè´Ÿè½½è®¡ç®—æ˜¯ä¸€ä¸ªâ€œå¼€å§‹-ç»“æŸâ€çš„é—­ç¯æµ‹é‡è¿‡ç¨‹ï¼šå°†è¿è¡Œè€—æ—¶è®°å½•åœ¨

#### A. é—­ç¯æµ‹é‡ (Start-Stop Measurement)

è´Ÿè½½çš„æœ¬è´¨æ˜¯**CPU ä½¿ç”¨æ—¶é—´**ã€‚è¦å‡†ç¡®è®¡ç®—ä¸€ä¸ªä»»åŠ¡ç”¨äº†å¤šå°‘ CPUï¼Œå¿…é¡»çŸ¥é“å®ƒâ€œä»€ä¹ˆæ—¶å€™å¼€å§‹â€å’Œâ€œä»€ä¹ˆæ—¶å€™ç»“æŸâ€ã€‚

1. **å¼€å§‹ (`p2dq_running`)**: å½“ä»»åŠ¡è¢«è°ƒåº¦ä¸Š CPU æ—¶ï¼Œ`p2dq_running` ä¼šè®°å½•å½“å‰æ—¶é—´æˆ³ï¼š

   C

   ```
   // scx_p2dq/src/bpf/main.bpf.c
   taskc->last_run_at = now; //
   ```

2. **ç»“æŸ (`p2dq_stopping`)**: å½“ä»»åŠ¡ç¦»å¼€ CPU æ—¶ï¼Œ`p2dq_stopping` è®¡ç®—å·®å€¼ï¼š

   C

   ```
   // scx_p2dq/src/bpf/main.bpf.c
   used = now - taskc->last_run_at; // è®¡ç®—æœ¬æ¬¡è¿è¡Œçš„ç²¾ç¡®æ—¶é•¿
   ```

**ä¸ºä»€ä¹ˆå‡†ç¡®ï¼Ÿ** å› ä¸º `stopping` æ—¶åˆ»æ˜¯ä»»åŠ¡æœ¬æ¬¡å ç”¨ CPU çš„**ç»ˆç‚¹**ã€‚åªæœ‰åˆ°äº†ç»ˆç‚¹ï¼Œæˆ‘ä»¬æ‰èƒ½ç¡®å®šå®ƒåˆ°åº•è·‘äº†å¤šä¹…ã€‚å¦‚æœåœ¨ä»»åŠ¡è¿è¡Œä¸­é—´å»é‡‡æ ·ï¼ˆæ¯”å¦‚æ¯ç§’æ‰«æä¸€æ¬¡ï¼‰ï¼Œåè€Œä¸å¦‚è¿™ç§åŸºäºäº‹ä»¶çš„ç»Ÿè®¡ç²¾ç¡®ã€‚

#### B. é¢‘ç¹çš„æ›´æ–°é¢‘ç‡ (High Frequency)

ä½ å¯èƒ½ä¼šæ‹…å¿ƒï¼š*â€œå¦‚æœä¸€ä¸ªä»»åŠ¡ä¸€ç›´è·‘ï¼Œå¾ˆä¹…ä¸è°ƒç”¨ stoppingï¼Œè´Ÿè½½æ•°æ®å²‚ä¸æ˜¯æ—§çš„ï¼Ÿâ€*

åœ¨ `scx` å’Œ `p2dq` çš„è®¾è®¡ä¸­ï¼Œè¿™æ˜¯é€šè¿‡**æ—¶é—´ç‰‡ï¼ˆTime Sliceï¼‰**æ¥ä¿è¯çš„ã€‚

- `p2dq` è®¾å®šäº† `timeline_config.max_exec_ns`ï¼ˆé»˜è®¤ 20msï¼‰ã€‚
- å¦‚æœä¸€ä¸ªä»»åŠ¡æ˜¯ CPU å¯†é›†å‹çš„ï¼ˆä¸€ç›´è·‘ï¼‰ï¼Œå†…æ ¸ä¼šå¼ºåˆ¶è§¦å‘æ—¶é—´ç‰‡ä¸­æ–­ã€‚
- è¿™ä¼šå¯¼è‡´ä»»åŠ¡è¢«â€œèµ¶ä¸‹â€ CPUï¼ˆè§¦å‘ `stopping`ï¼‰ï¼Œæ›´æ–°è´Ÿè½½ï¼Œç„¶åå¯èƒ½ç«‹å³åˆè¢«è°ƒåº¦ä¸Šæ¥ï¼ˆè§¦å‘ `running`ï¼‰ã€‚

å› æ­¤ï¼Œè´Ÿè½½æ•°æ®çš„æ›´æ–°é¢‘ç‡è‡³å°‘æ˜¯å‡ åæ¯«ç§’ä¸€æ¬¡ï¼Œå¯¹äºè´Ÿè½½å‡è¡¡å†³ç­–æ¥è¯´ï¼Œè¿™ä¸ªâ€œå®æ—¶æ€§â€å·²ç»è¶³å¤Ÿå‡†ç¡®ã€‚

#### C. PELT ç®—æ³•çš„é›†æˆ (æŒ‡æ•°è¡°å‡)

ä»£ç ä¸­ä¸ä»…ä»…æ˜¯ç®€å•çš„ç´¯åŠ ï¼Œè¿˜ä½¿ç”¨äº†ç±»ä¼¼å†…æ ¸ PELT (Per-Entity Load Tracking) çš„ç®—æ³•ï¼š

C

```
// scx_p2dq/src/bpf/main.bpf.c -> p2dq_stopping

/* Update PELT metrics if enabled */
if (p2dq_config.pelt_enabled) {
    update_task_pelt(taskc, now, used, task_cpu); // æ›´æ–°ä»»åŠ¡çš„ PELT
    aggregate_pelt_to_llc(llcx, taskc, ...);      // å°†ä»»åŠ¡è´Ÿè½½èšåˆåˆ° LLC
} else {
    __sync_fetch_and_add(&llcx->load, used);      // ç®€å•æ¨¡å¼ï¼šç›´æ¥ç´¯åŠ æ—¶é—´
}
```

- **`update_task_pelt`**: è¿™ä¸ªå‡½æ•°ä¸ä»…åŠ ä¸Šäº†æœ¬æ¬¡è¿è¡Œçš„ `used` æ—¶é—´ï¼Œè¿˜ä¼šæ ¹æ®è·ç¦»ä¸Šæ¬¡æ›´æ–°çš„æ—¶é—´é—´éš”è¿›è¡Œ**æŒ‡æ•°è¡°å‡**ã€‚
- è¿™æ„å‘³ç€ï¼šæ—§çš„è´Ÿè½½æƒé‡ä¼šé€æ¸é™ä½ï¼Œæ–°çš„è´Ÿè½½æƒé‡æ›´é«˜ã€‚è¿™ç§æœºåˆ¶ä½¿å¾— `util_avg` èƒ½å¤Ÿå¹³æ»‘ä¸”å‡†ç¡®åœ°åæ˜ â€œæœ€è¿‘çš„â€è´Ÿè½½å‹åŠ›ï¼Œè€Œä¸æ˜¯å†å²æ€»å’Œã€‚



æˆ‘ä»¬çš„è°ƒåº¦ç®—æ³•ï¼šæ ¹æ®p2dqç®—æ³•è¿›è¡Œä¿®æ”¹ï¼Œ

1.å°†llcç²’åº¦çš„è´Ÿè½½è®°å½•ä¿®æ”¹æˆcpuç²’åº¦çš„

2.å»é™¤ä¸éœ€è¦çš„é€»è¾‘ï¼Œä»…è®°å½•è´Ÿè½½æƒ…å†µå’ŒPELTç®—æ³•(éšæ—¶é—´è¡°å‡)ï¼Œä½¿ç”¨è™šæ‹Ÿæ—¶é—´



æ·»åŠ ä¸¤ä¸ªé’©å­ç‚¹ï¼š

running

stopping

ç»“æ„ä½“ä¸­æ·»åŠ cpuç²’åº¦çš„å­—æ®µï¼š

```
// 1. å®šä¹‰ä¸Šä¸‹æ–‡
struct task_ctx {
    u64 last_run_at;
};

// 2. Running: è®°è´¦å¼€å§‹
void BPF_STRUCT_OPS(my_running, struct task_struct *p)
{
    struct task_ctx *tctx = bpf_task_storage_get(&task_kptr, p, 0, 0);
    if (tctx)
        tctx->last_run_at = bpf_ktime_get_ns(); // è®°å½•å¼€å§‹æ—¶é—´
}

// 3. Stopping: è®°è´¦ç»“æŸ + ç®—è´Ÿè½½
void BPF_STRUCT_OPS(my_stopping, struct task_struct *p, bool runnable)
{
    struct task_ctx *tctx = bpf_task_storage_get(&task_kptr, p, 0, 0);
    if (!tctx) return;

    u64 now = bpf_ktime_get_ns();
    u64 delta = now - tctx->last_run_at; // ç®—å‡ºè¿™æ¬¡è·‘äº†å¤šä¹…

    // A. ç®—è´Ÿè½½ (æœ€ç®€å•çš„ç´¯åŠ æ³•ï¼Œå»ºè®®æ¢æˆ PELT)
    struct cpu_ctx *cpuc = bpf_per_cpu_ptr(&cpu_ctxs, bpf_get_smp_processor_id());
    if (cpuc)
        cpuc->load += delta; 

    // B. ç®—å…¬å¹³æ€§ (å¦‚æœæ˜¯ vtime è°ƒåº¦)
    p->scx.dsq_vtime += delta;
}
```



```mermaid
graph TD
    %% å®šä¹‰æ ·å¼
    classDef struct fill:#e1f5fe,stroke:#01579b,stroke-width:2px;
    classDef action fill:#fff9c4,stroke:#fbc02d,stroke-width:2px;
    classDef logic fill:#f3e5f5,stroke:#7b1fa2,stroke-width:2px;

    subgraph "é˜¶æ®µä¸€ï¼šä»»åŠ¡å¼€å§‹è¿è¡Œ (ops.running)"
        RunStart("ğŸš€ è§¦å‘ ops.running(p)"):::action
        
        GetTaskCtx1["è·å–ä»»åŠ¡ä¸Šä¸‹æ–‡<br>struct task_ctx *taskc"]:::struct
        RunStart --> GetTaskCtx1

        GetTime1["è·å–å½“å‰æ—¶é—´<br>u64 now = bpf_ktime_get_ns()"]:::logic
        GetTaskCtx1 --> GetTime1

        UpdateStartT["æ›´æ–°å¼€å§‹æ—¶é—´<br>taskc->last_run_at = now"]:::struct
        GetTime1 --> UpdateStartT
    end

    subgraph "é˜¶æ®µäºŒï¼šä»»åŠ¡åœæ­¢è¿è¡Œ (ops.stopping)"
        StopStart("ğŸ›‘ è§¦å‘ ops.stopping(p, runnable)"):::action
        UpdateStartT -.->|"ä»»åŠ¡æ‰§è¡Œä¸­..."| StopStart

        GetTaskCtx2["è·å–ä»»åŠ¡ä¸Šä¸‹æ–‡<br>struct task_ctx *taskc"]:::struct
        StopStart --> GetTaskCtx2

        GetTime2["è·å–å½“å‰æ—¶é—´<br>u64 now = bpf_ktime_get_ns()"]:::logic
        GetTaskCtx2 --> GetTime2

        CalcDelta["è®¡ç®—è¿è¡Œå·®å€¼ (Delta)<br>u64 delta = now - taskc->last_run_at"]:::logic
        GetTime2 --> CalcDelta

        GetCpuCtx["è·å–å½“å‰ CPU ä¸Šä¸‹æ–‡<br>struct cpu_ctx *cpuc = bpf_per_cpu_ptr(...)"]:::struct
        CalcDelta --> GetCpuCtx

        subgraph "æ ¸å¿ƒè´Ÿè½½æ›´æ–°é€»è¾‘ (CPUç²’åº¦)"
            CheckPelt{"æ˜¯å¦å¯ç”¨ PELT?"}
            
            %% åˆ†æ”¯Aï¼šç®€å•ç´¯åŠ æ¨¡å¼
            SimpleLoad["ç®€å•æ¨¡å¼: ç›´æ¥ç´¯åŠ <br>cpuc->load += delta"]:::struct
            
            %% åˆ†æ”¯Bï¼šPELT æ¨¡å¼ (å‚è€ƒ p2dq å®ç°)
            PeltLoad["PELT æ¨¡å¼: æŒ‡æ•°è¡°å‡æ›´æ–°<br>1. è¡°å‡ cpuc->util_avg<br>2. åŠ æƒç´¯åŠ  delta åˆ° cpuc->util_avg"]:::struct
            
            CheckPelt -- "å¦ (Legacy)" --> SimpleLoad
            CheckPelt -- "æ˜¯ (æ¨è)" --> PeltLoad
        end
        
        GetCpuCtx --> CheckPelt

        UpdateVtime["æ›´æ–°è™šæ‹Ÿæ—¶é—´ (å…¬å¹³æ€§)<br>p->scx.dsq_vtime += delta"]:::struct
        SimpleLoad --> UpdateVtime
        PeltLoad --> UpdateVtime
    end
```

